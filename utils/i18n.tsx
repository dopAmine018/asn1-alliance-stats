import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react';
import { Language } from '../types';

type TranslationKey = 
  | 'nav.public' | 'nav.admin' | 'nav.logout'
  | 'form.title' | 'form.success' | 'form.submit' | 'form.saving' | 'form.optional' | 'form.required_error'
  | 'section.identity' | 'section.identity.desc' | 'section.power' | 'section.power.desc' | 'section.techtree' | 'section.techtree.desc'
  | 'section.buildings' | 'section.buildings.status'
  | 'label.language' | 'label.name' | 'label.power' | 'label.squad2' | 'label.squad3' | 'label.squad4' | 'label.totalHeroPower'
  | 'placeholder.server_rank'
  | 'stat.hero' | 'stat.duel' | 'stat.units'
  | 't10.title' | 't10.morale' | 't10.protection' | 't10.hp' | 't10.atk' | 't10.def'
  | 'level.tech' | 'level.barracks' | 'level.tank' | 'level.air' | 'level.missile'
  | 'card.hero_pwr' | 'card.tech_short' | 'card.barr_short' | 'card.tank_short' | 'card.air_short' | 'card.misl_short'
  | 'viewer.leaderboard' | 'viewer.search' | 'viewer.sort' | 'viewer.showing' | 'viewer.no_results' | 'viewer.updated' | 'viewer.export'
  | 'sort.newest' | 'sort.oldest' | 'sort.highest_power' | 'sort.lowest_power'
  | 'sort.highest_total_hero_power' | 'sort.lowest_total_hero_power'
  | 'admin.login.title' | 'admin.login.btn' | 'admin.dashboard' | 'admin.password' | 'admin.db' | 'admin.vs' | 'admin.filter'
  | 'admin.active_only' | 'admin.all_records' | 'admin.status' | 'admin.identity' | 'admin.control' | 'admin.terminate' | 'admin.save' | 'admin.cancel' | 'admin.edit' | 'admin.del'
  | 'vs.select' | 'vs.create_btn' | 'vs.extract' | 'vs.modal_title' | 'vs.modal_placeholder' | 'vs.abort' | 'vs.launch' 
  | 'vs.agent' | 'vs.sum' | 'vs.add_agent_ph' | 'vs.inject' | 'vs.awaiting'
  | 'day.mon' | 'day.tue' | 'day.wed' | 'day.thu' | 'day.fri' | 'day.sat';

const translations: Record<Language, Record<TranslationKey, string>> = {
  english: {
    'nav.public': 'Public View',
    'nav.admin': 'Admin Panel',
    'nav.logout': 'Logout',
    'form.title': 'Submit / Update Stats',
    'form.success': 'Stats saved successfully!',
    'form.submit': 'Save Player Stats',
    'form.saving': 'Saving...',
    'form.optional': 'Optional',
    'form.required_error': 'Please fill all required fields (Squads, Hero Power, Buildings)',
    'section.identity': '01 // Identity',
    'section.identity.desc': 'Verify commander credentials. Name must match in-game profile exactly.',
    'section.power': '02 // Combat Power',
    'section.power.desc': 'Smart Format: 24.5 = 24.5M',
    'section.techtree': '03 // Tech',
    'section.techtree.desc': 'Fill these values from your Tech Center stats.',
    'section.buildings': '04 // Building Levels',
    'section.buildings.status': 'System Status: Online',
    'label.language': 'Language',
    'label.name': 'In-game name',
    'label.power': 'First Squad Power',
    'label.squad2': 'Squad 2',
    'label.squad3': 'Squad 3',
    'label.squad4': 'Squad 4',
    'label.totalHeroPower': 'Total Hero Power',
    'placeholder.server_rank': 'Get it from Server Rankings',
    'stat.hero': 'Hero %',
    'stat.duel': "VS 'Duel' %",
    'stat.units': 'Units %',
    't10.title': 'Tier 10 Bonuses',
    't10.morale': 'T10 advancement+morale [Morale]',
    't10.protection': 'T10 advancement+morale [Advanced Protection]',
    't10.hp': 'T10 advancement+morale [HP Boost 3]',
    't10.atk': 'T10 advancement+morale [Attack Boost 3]',
    't10.def': 'T10 advancement+morale [Defense Boost 3]',
    'level.tech': 'Tech Center',
    'level.barracks': 'Barracks',
    'level.tank': 'Tank Center',
    'level.air': 'Air Center',
    'level.missile': 'Missile Center',
    'card.hero_pwr': 'HERO PWR',
    'card.tech_short': 'Tech',
    'card.barr_short': 'Barr',
    'card.tank_short': 'Tank',
    'card.air_short': 'Air',
    'card.misl_short': 'Misl',
    'viewer.leaderboard': 'Leaderboard',
    'viewer.search': 'Search name...',
    'viewer.sort': 'Sort by',
    'viewer.showing': 'Showing active players',
    'viewer.no_results': 'No players found matching your criteria.',
    'viewer.updated': 'Updated',
    'viewer.export': 'Export CSV',
    'sort.newest': 'Newest Update',
    'sort.oldest': 'Oldest Update',
    'sort.highest_power': 'Highest Power',
    'sort.lowest_power': 'Lowest Power',
    'sort.highest_total_hero_power': 'Highest Hero Power',
    'sort.lowest_total_hero_power': 'Lowest Hero Power',
    'admin.login.title': 'Admin Access',
    'admin.login.btn': 'Unlock Panel',
    'admin.dashboard': 'Admin Dashboard',
    'admin.password': 'Enter Password',
    'admin.db': 'Database',
    'admin.vs': 'VS Duel',
    'admin.filter': 'Filter Records...',
    'admin.active_only': 'Active Only',
    'admin.all_records': 'All Records',
    'admin.status': 'Status',
    'admin.identity': 'Identity',
    'admin.control': 'Control',
    'admin.terminate': 'Terminate Session',
    'admin.save': 'Save',
    'admin.cancel': 'Cancel',
    'admin.edit': 'Edit',
    'admin.del': 'Del',
    'vs.select': 'Select Duel',
    'vs.create_btn': '+ Duel',
    'vs.extract': 'Extract Data',
    'vs.modal_title': 'Init VS Duel',
    'vs.modal_placeholder': 'Duel Name (e.g. Week 4)',
    'vs.abort': 'Abort',
    'vs.launch': 'Launch',
    'vs.agent': 'Agent',
    'vs.sum': 'Sum',
    'vs.add_agent_ph': 'Add Agent...',
    'vs.inject': 'Inject Row',
    'vs.awaiting': 'Awaiting Duel Selection...',
    'day.mon': 'Mon',
    'day.tue': 'Tue',
    'day.wed': 'Wed',
    'day.thu': 'Thu',
    'day.fri': 'Fri',
    'day.sat': 'Sat',
  },
  arabic: {
    'nav.public': 'عرض عام',
    'nav.admin': 'لوحة المشرف',
    'nav.logout': 'تسجيل خروج',
    'form.title': 'إرسال / تحديث الإحصائيات',
    'form.success': 'تم حفظ الإحصائيات بنجاح!',
    'form.submit': 'حفظ الإحصائيات',
    'form.saving': 'جاري الحفظ...',
    'form.optional': 'اختياري',
    'form.required_error': 'يرجى ملء جميع الحقول المطلوبة (الفرق، قوة الأبطال، المباني)',
    'section.identity': '01 // الهوية',
    'section.identity.desc': 'تحقق من بيانات القائد. يجب أن يتطابق الاسم تماماً مع الملف الشخصي في اللعبة.',
    'section.power': '02 // القوة القتالية',
    'section.power.desc': 'التنسيق الذكي: 24.5 = 24.5 مليون',
    'section.techtree': '03 // التقنية',
    'section.techtree.desc': 'املأ هذه القيم من إحصائيات مركز التقنية.',
    'section.buildings': '04 // مستويات المباني',
    'section.buildings.status': 'حالة النظام: متصل',
    'label.language': 'اللغة',
    'label.name': 'اسم اللاعب في اللعبة',
    'label.power': 'قوة الفريق الأول',
    'label.squad2': 'الفريق 2',
    'label.squad3': 'الفريق 3',
    'label.squad4': 'الفريق 4',
    'label.totalHeroPower': 'إجمالي قوة الأبطال',
    'placeholder.server_rank': 'احصل عليها من تصنيفات السيرفر',
    'stat.hero': 'الأبطال%',
    'stat.duel': 'مبارزة التحالف %',
    'stat.units': 'الجنود %',
    't10.title': 'مكافآت المستوى 10',
    't10.morale': 'تقدم الجنود 10+الجبروت [الجبروت]',
    't10.protection': 'تقدم الجنود 10+الجبروت [حماية متقدمة]',
    't10.hp': 'تقدم الجنود 10+الجبروت [تعزيز الحياة 3]',
    't10.atk': 'تقدم الجنود 10+الجبروت [تعزيز الهجوم 3]',
    't10.def': 'تقدم الجنود 10+الجبروت [تعزيز الدفاع 3]',
    'level.tech': 'مركز التقنية',
    'level.barracks': 'الثكنة',
    'level.tank': 'مركز الدبابات',
    'level.air': 'مركز الطيران',
    'level.missile': 'مركز الصواريخ',
    'card.hero_pwr': 'قوة الأبطال',
    'card.tech_short': 'تقنية',
    'card.barr_short': 'ثكنة',
    'card.tank_short': 'دبابة',
    'card.air_short': 'طيران',
    'card.misl_short': 'صواريخ',
    'viewer.leaderboard': 'لوحة المتصدرين',
    'viewer.search': 'بحث عن اسم...',
    'viewer.sort': 'ترتيب حسب',
    'viewer.showing': 'لاعب نشط',
    'viewer.no_results': 'لم يتم العثور على لاعبين.',
    'viewer.updated': 'تحديث',
    'viewer.export': 'تصدير CSV',
    'sort.newest': 'الأحدث',
    'sort.oldest': 'الأقدم',
    'sort.highest_power': 'الأعلى قوة',
    'sort.lowest_power': 'الأقل قوة',
    'sort.highest_total_hero_power': 'أعلى قوة أبطال',
    'sort.lowest_total_hero_power': 'أقل قوة أبطال',
    'admin.login.title': 'دخول المشرف',
    'admin.login.btn': 'دخول',
    'admin.dashboard': 'لوحة تحكم المشرف',
    'admin.password': 'كلمة المرور',
    'admin.db': 'قاعدة البيانات',
    'admin.vs': 'تحدي VS',
    'admin.filter': 'تصفية السجلات...',
    'admin.active_only': 'النشطين فقط',
    'admin.all_records': 'كل السجلات',
    'admin.status': 'الحالة',
    'admin.identity': 'الهوية',
    'admin.control': 'تحكم',
    'admin.terminate': 'إنهاء الجلسة',
    'admin.save': 'حفظ',
    'admin.cancel': 'إلغاء',
    'admin.edit': 'تعديل',
    'admin.del': 'حذف',
    'vs.select': 'اختر التحدي',
    'vs.create_btn': '+ تحدي',
    'vs.extract': 'استخراج البيانات',
    'vs.modal_title': 'بدء تحدي جديد',
    'vs.modal_placeholder': 'اسم التحدي (مثال: الأسبوع 4)',
    'vs.abort': 'إلغاء',
    'vs.launch': 'إطلاق',
    'vs.agent': 'العميل',
    'vs.sum': 'المجموع',
    'vs.add_agent_ph': 'أضف عميل...',
    'vs.inject': 'إدراج صف',
    'vs.awaiting': 'بانتظار اختيار التحدي...',
    'day.mon': 'الإثنين',
    'day.tue': 'الثلاثاء',
    'day.wed': 'الأربعاء',
    'day.thu': 'الخميس',
    'day.fri': 'الجمعة',
    'day.sat': 'السبت',
  },
  turkish: {
    'nav.public': 'Genel Görünüm',
    'nav.admin': 'Yönetici Paneli',
    'nav.logout': 'Çıkış',
    'form.title': 'İstatistik Gönder / Güncelle',
    'form.success': 'İstatistikler başarıyla kaydedildi!',
    'form.submit': 'İstatistikleri Kaydet',
    'form.saving': 'Kaydediliyor...',
    'form.optional': 'İsteğe bağlı',
    'form.required_error': 'Lütfen gerekli tüm alanları doldurun (Takımlar, Kahraman Gücü, Binalar)',
    'section.identity': '01 // Kimlik',
    'section.identity.desc': 'Komutan bilgilerini doğrulayın. İsim oyun içi profille tam eşleşmelidir.',
    'section.power': '02 // Savaş Gücü',
    'section.power.desc': 'Akıllı Format: 24.5 = 24.5M',
    'section.techtree': '03 // Teknoloji',
    'section.techtree.desc': 'Bu değerleri Teknoloji Merkezi istatistiklerinizden doldurun.',
    'section.buildings': '04 // Bina Seviyeleri',
    'section.buildings.status': 'Sistem Durumu: Çevrimiçi',
    'label.language': 'Dil',
    'label.name': 'Oyun İçi İsim',
    'label.power': '1. Takım Gücü',
    'label.squad2': '2. Takım',
    'label.squad3': '3. Takım',
    'label.squad4': '4. Takım',
    'label.totalHeroPower': 'Toplam Kahraman Gücü',
    'placeholder.server_rank': 'Sunucu Sıralamasından al',
    'stat.hero': 'Kahraman %',
    'stat.duel': "VS 'Düello' %",
    'stat.units': 'Birim %',
    't10.title': 'Seviye 10 Bonusları',
    't10.morale': 'T10 İlerlemesi + Moral [Moral]',
    't10.protection': 'T10 İlerlemesi + Moral [Gelişmiş Koruma]',
    't10.hp': 'T10 İlerlemesi + Moral [HP Artışı 3]',
    't10.atk': 'T10 İlerlemesi + Moral [Saldırı Artışı 3]',
    't10.def': 'T10 İlerlemesi + Moral [Savunma Artışı 3]',
    'level.tech': 'Teknoloji Mrk.',
    'level.barracks': 'Kışla',
    'level.tank': 'Tank Mrk.',
    'level.air': 'Hava Mrk.',
    'level.missile': 'Füze Mrk.',
    'card.hero_pwr': 'KAHRAMAN GÜCÜ',
    'card.tech_short': 'Tekn',
    'card.barr_short': 'Kışla',
    'card.tank_short': 'Tank',
    'card.air_short': 'Hava',
    'card.misl_short': 'Füze',
    'viewer.leaderboard': 'Liderlik Tablosu',
    'viewer.search': 'İsim ara...',
    'viewer.sort': 'Sırala',
    'viewer.showing': 'aktif oyuncu gösteriliyor',
    'viewer.no_results': 'Kriterlere uygun oyuncu bulunamadı.',
    'viewer.updated': 'Güncellendi',
    'viewer.export': 'CSV İndir',
    'sort.newest': 'En Yeni',
    'sort.oldest': 'En Eski',
    'sort.highest_power': 'En Yüksek Güç',
    'sort.lowest_power': 'En Düşük Güç',
    'sort.highest_total_hero_power': 'En Yüksek Kahraman Gücü',
    'sort.lowest_total_hero_power': 'En Düşük Kahraman Gücü',
    'admin.login.title': 'Yönetici Girişi',
    'admin.login.btn': 'Giriş',
    'admin.dashboard': 'Yönetici Paneli',
    'admin.password': 'Şifre',
    'admin.db': 'Veritabanı',
    'admin.vs': 'VS Düellosu',
    'admin.filter': 'Kayıtları Filtrele...',
    'admin.active_only': 'Sadece Aktif',
    'admin.all_records': 'Tüm Kayıtlar',
    'admin.status': 'Durum',
    'admin.identity': 'Kimlik',
    'admin.control': 'Kontrol',
    'admin.terminate': 'Oturumu Sonlandır',
    'admin.save': 'Kaydet',
    'admin.cancel': 'İptal',
    'admin.edit': 'Düzenle',
    'admin.del': 'Sil',
    'vs.select': 'Düello Seç',
    'vs.create_btn': '+ Düello',
    'vs.extract': 'Veri Çıkar',
    'vs.modal_title': 'VS Düellosu Başlat',
    'vs.modal_placeholder': 'Düello Adı (örn. Hafta 4)',
    'vs.abort': 'İptal',
    'vs.launch': 'Başlat',
    'vs.agent': 'Ajan',
    'vs.sum': 'Toplam',
    'vs.add_agent_ph': 'Ajan Ekle...',
    'vs.inject': 'Satır Ekle',
    'vs.awaiting': 'Düello Seçimi Bekleniyor...',
    'day.mon': 'Pzt',
    'day.tue': 'Sal',
    'day.wed': 'Çar',
    'day.thu': 'Per',
    'day.fri': 'Cum',
    'day.sat': 'Cmt',
  },
  indonesian: {
    'nav.public': 'Tampilan Publik',
    'nav.admin': 'Panel Admin',
    'nav.logout': 'Keluar',
    'form.title': 'Kirim / Perbarui Statistik',
    'form.success': 'Statistik berhasil disimpan!',
    'form.submit': 'Simpan Statistik',
    'form.saving': 'Menyimpan...',
    'form.optional': 'Opsional',
    'form.required_error': 'Harap isi semua kolom yang wajib diisi (Pasukan, Kekuatan Hero, Bangunan)',
    'section.identity': '01 // Identitas',
    'section.identity.desc': 'Verifikasi kredensial komandan. Nama harus sama persis dengan profil dalam game.',
    'section.power': '02 // Kekuatan Tempur',
    'section.power.desc': 'Format Cerdas: 24.5 = 24.5M',
    'section.techtree': '03 // Teknologi',
    'section.techtree.desc': 'Isi nilai-nilai ini dari statistik Pusat Teknologi Anda.',
    'section.buildings': '04 // Level Bangunan',
    'section.buildings.status': 'Status Sistem: Online',
    'label.language': 'Bahasa',
    'label.name': 'Nama Dalam Game',
    'label.power': 'Kekuatan Pasukan Pertama',
    'label.squad2': 'Pasukan 2',
    'label.squad3': 'Pasukan 3',
    'label.squad4': 'Pasukan 4',
    'label.totalHeroPower': 'Total Kekuatan Hero',
    'placeholder.server_rank': 'Dapatkan dari Peringkat Server',
    'stat.hero': "Hero %",
    'stat.duel': "VS 'Duel' %",
    'stat.units': 'Unit %',
    't10.title': 'Bonus Tier 10',
    't10.morale': 'Perkembangan T10 + Moral [Moral]',
    't10.protection': 'Perkembangan T10 + Moral [Perlindungan Lanjut]',
    't10.hp': 'Perkembangan T10 + Moral [Peningkatan HP 3]',
    't10.atk': 'Perkembangan T10 + Moral [Peningkatan ATK 3]',
    't10.def': 'Perkembangan T10 + Moral [Peningkatan DEF 3]',
    'level.tech': 'Pusat Teknologi',
    'level.barracks': 'Barak',
    'level.tank': 'Pusat Tank',
    'level.air': 'Pusat Udara',
    'level.missile': 'Pusat Rudal',
    'card.hero_pwr': 'KEKUATAN HERO',
    'card.tech_short': 'Tek',
    'card.barr_short': 'Barak',
    'card.tank_short': 'Tank',
    'card.air_short': 'Udara',
    'card.misl_short': 'Rudal',
    'viewer.leaderboard': 'Papan Peringkat',
    'viewer.search': 'Cari nama...',
    'viewer.sort': 'Urutkan',
    'viewer.showing': 'pemain aktif',
    'viewer.no_results': 'Tidak ada pemain ditemukan.',
    'viewer.updated': 'Diperbarui',
    'viewer.export': 'Ekspor CSV',
    'sort.newest': 'Terbaru',
    'sort.oldest': 'Terlama',
    'sort.highest_power': 'Kekuatan Tertinggi',
    'sort.lowest_power': 'Kekuatan Terendah',
    'sort.highest_total_hero_power': 'Kekuatan Hero Tertinggi',
    'sort.lowest_total_hero_power': 'Kekuatan Hero Terendah',
    'admin.login.title': 'Login Admin',
    'admin.login.btn': 'Masuk',
    'admin.dashboard': 'Dasbor Admin',
    'admin.password': 'Kata Sandi',
    'admin.db': 'Database',
    'admin.vs': 'Duel VS',
    'admin.filter': 'Filter Rekaman...',
    'admin.active_only': 'Hanya Aktif',
    'admin.all_records': 'Semua Rekaman',
    'admin.status': 'Status',
    'admin.identity': 'Identitas',
    'admin.control': 'Kontrol',
    'admin.terminate': 'Akhiri Sesi',
    'admin.save': 'Simpan',
    'admin.cancel': 'Batal',
    'admin.edit': 'Ubah',
    'admin.del': 'Hapus',
    'vs.select': 'Pilih Duel',
    'vs.create_btn': '+ Duel',
    'vs.extract': 'Ekstrak Data',
    'vs.modal_title': 'Mulai Duel VS',
    'vs.modal_placeholder': 'Nama Duel (mis. Minggu 4)',
    'vs.abort': 'Batalkan',
    'vs.launch': 'Luncurkan',
    'vs.agent': 'Agen',
    'vs.sum': 'Jumlah',
    'vs.add_agent_ph': 'Tambah Agen...',
    'vs.inject': 'Masukkan Baris',
    'vs.awaiting': 'Menunggu Pilihan Duel...',
    'day.mon': 'Sen',
    'day.tue': 'Sel',
    'day.wed': 'Rab',
    'day.thu': 'Kam',
    'day.fri': 'Jum',
    'day.sat': 'Sab',
  }
};

interface LanguageContextType {
  language: Language;
  setLanguage: (lang: Language) => void;
  t: (key: TranslationKey) => string;
  dir: 'ltr' | 'rtl';
}

const LanguageContext = createContext<LanguageContextType | undefined>(undefined);

export const LanguageProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  const [language, setLanguage] = useState<Language>('english');

  useEffect(() => {
    // Detect Browser Language
    const browserLang = navigator.language.split('-')[0];
    if (browserLang === 'ar') setLanguage('arabic');
    else if (browserLang === 'tr') setLanguage('turkish');
    else if (browserLang === 'id') setLanguage('indonesian');
    else setLanguage('english');
  }, []);

  const t = (key: TranslationKey): string => {
    return translations[language][key] || key;
  };

  const dir = language === 'arabic' ? 'rtl' : 'ltr';

  return (
    <LanguageContext.Provider value={{ language, setLanguage, t, dir }}>
      <div dir={dir} className={language === 'arabic' ? 'font-sans' : ''}>
        {children}
      </div>
    </LanguageContext.Provider>
  );
};

export const useLanguage = () => {
  const context = useContext(LanguageContext);
  if (!context) {
    throw new Error('useLanguage must be used within a LanguageProvider');
  }
  return context;
};